# vitrez_microservices

######### kubernetes-1 ###################################################

Что было сделано:

- Созданы манифесты comment-deployment.yml, mongo-deployment.yml, post-deployment.yml и ui-deployment.yml для нашего микросервисного приложения
- Создан кластер Kubernetes по руководству "Kubernetes The Hard Way" и запущены на нём наши приложения:

# kubectl get pods -o wide --all-namespaces
NAMESPACE     NAME                                  READY   STATUS    RESTARTS   AGE     IP           NODE       NOMINATED NODE   READINESS GATES
default       busybox                               1/1     Running   3          3h13m   10.200.0.4   worker-0   <none>           <none>
default       comment-deployment-5977b8df97-88l5n   1/1     Running   0          138m    10.200.0.8   worker-0   <none>           <none>
default       mongo-deployment-86d49445c4-gphr2     1/1     Running   0          140m    10.200.0.6   worker-0   <none>           <none>
default       nginx-554b9c67f9-zth5h                1/1     Running   0          177m    10.200.0.5   worker-0   <none>           <none>
default       post-deployment-f446744b7-hgz76       1/1     Running   0          139m    10.200.0.7   worker-0   <none>           <none>
default       ui-deployment-6dfcdd8c95-cctrw        1/1     Running   0          138m    10.200.0.9   worker-0   <none>           <none>
kube-system   coredns-5fb99965-d4kj8                1/1     Running   0          3h19m   10.200.0.2   worker-0   <none>           <none>
kube-system   coredns-5fb99965-gtsr7                1/1     Running   0          3h19m   10.200.0.3   worker-0   <none>           <none>


######### logging-1 ###################################################

Что было сделано:

- Обновлён код микросервисов для добавления функционала логирования
- Создан docker-compose-logging.yml, настроен fluentd и поднят стэк EFK
- Настроена отправка логов с помощью fluentd и проверено их появление в Kibana
- Опробованы различные фильтры для разбора лог-сообщений
- Подключен сбор логов с ui, опробован парсинг с регулярным выражением и grok-шаблоном
- Подключен zipkin для трейсинга наших сервисов и опробован в работе
- Lобавлен ещё один grok-шаблон для разборки обоих форматов логов UI-сервиса

######### monitoring-2 ###################################################

Что было сделано:

- Разделён конфигурционный файл docker compose на два - один для основных сервисов и один для сервисов мониторинга и алертинга
- Подключен cAdvisor для сбора информации о ресурсах, потребляемых контейнерами
- Установлена Grafana и подключена к нашему Prometheus как к источнику данных, подключен дашборд Docker and system monitoring
- Создан дашборд по отслеживанию ошибок отображения UI, поправлен график ui_request_count для отображения полезной информации
- Добавлен график с отображением 95 процентиля времени ответа на запрос
- Добавлен мониторинг бизнес-логики (счётчики кол-ва постов и комментариев)
- Добавлен Alertmanager и настроен на отправку в Slack уведомлений о недоступных контейнерах
- Все образы сервисов запушены в докер-хаб
- Обновлён Makefile

######### monitoring-1 ###################################################

Что было сделано:

- В GCP созданы firewall-правила и инстанс с помощью docker-machine, запущен и опробован в работе контейнер prometheus
- Переделана структура папок в репозитории, создан конфигурационный файл для prometheus с настройками для мониторинга наших сервисов и собран docker-образ prometheus с ним
- Обновлён docker-compose.yml - добавлен сервис prometheus, запущены все сервисы вместе, опробована и проверена работа мониторинга с помощью остановки и запуска разных сервисов
- Добавлен node exporter для мониторинга нашего docker host

В процессе выполнения заданий со звёздочкой сделано:
- Добавлен mongodb-exporter из проекта bitnami для мониторинга Mongo DB; он не билдится, а сразу скачивается и запускается через docker-compose
- Добавлен blackbox-exporter; взят готовый образ из докер-хаба, в который копируется наш конфигурационный файл
- Созданы докер-файлы для новых экспортеров, соответствующим образом модифицирован prometheus.yml, версии экспортеров зафиксированы на последних стабильных
- Сервис ui успешно чекается запросом http и отдает "200 OK", а сервисы comment и post при такой проверке отдавали коды 4xx, поэтому было принято решение чекать их только коннектом по TCP
- Создан Makefile, который может билдить образы раздельно и все вместе, пушить их в докер-хаб
- Все готовые образы отправлены в докер-хаб https://hub.docker.com/repositories/vitrez


######### gitlab-ci-1 ###################################################

Что было сделано:

- Создан инстанс с помощью docker-machine, установлен и настроен Gitlab CI с раннером (omnibus-установка)
- Создан проект и подключен к нашему локальному репозиторию
- Создан пайплан, запущен и зарегистрирован раннер, после чего пайплайн запустился и успешно прошёл
- Добавлены окружения staging and production с ручным развёртыванием, после чего добавлено и проверено ограничение развёртывания по тегу
- Добавлены динамические окружения
- Добавлены сборка и тестирование реального приложения reddit с раннером shell-executor, т.к. с раннером типа docker сборка DinD завершалась ошибкой.


######### docker-4 ###################################################

Что было сделано:

- Попрактиковали работу с сетью с использованием сетевых драйверов none, host, bridge
- Попробовали несколько раз подряд создать и запустить  контейнер на базе одного и того же образа nginx - запускается только первый, потому что для других порт 80 уже занят
- Успешно запустили наш проект в двух bridge-сетях и исследовали сеть хоста
- Установили docker-compose, создали файл конфигурации для запуска наших контейнеров с его помощью, успешно запустили контейнеры
- Изменили конфигурационный файл для использования множества сетей, параметризовали переменные, записали значения в .env-файл и успешно проверили работу docker-compose 
- Исследовали и поменяли префикс создаваемых docker-compse ресурсов - по умолчанию он добавляет имя папки, из которой запускается, заменить можно с помощью переменной окружения COMPOSE_PROJECT_NAME в файле .env или из командой строки: '-p / --project-name'
- Создали docker-compose.override.yml для запуска проекта с возможностью менять код приложений без пересборки образов и изменили способ запуска puma


######### docker-3 ###################################################

Что было сделано:

- Загружено и развёрнуто микросервисное приложение на docker-host, создана своя сеть
- Проверена работоспособность приложения при перезапуске контейнеров с другими сетевыми алиасами с помощью параметра --env
- Оптимизированы образы с использованием образа alpine:3.9.5 и заменой некоторых команд
- Создан и подключен Docker volume, проверена сохранность постов при пересоздании контейнеров


Пример команд по перезапуску с другими сетевыми алиасами:

docker run -d --network=reddit --network-alias=db mongo:latest
docker run -d --network=reddit --network-alias=srvP -e "POST_DATABASE_HOST=db"  vitrez/post:1.0
docker run -d --network=reddit --network-alias=srvC -e "COMMENT_DATABASE_HOST=db" vitrez/comment:1.0
docker run -d --network=reddit -p 9292:9292  -e "POST_SERVICE_HOST=srvP"  -e "COMMENT_SERVICE_HOST=srvC" vitrez/ui:1.0

######### docker-2 ###################################################

Что было сделано:

- Настроен новый репозиторий, установлены docker и docker-machine, создан новый проект в GCE
- Опробована работа с докером на примере базового образа hello-world, опробованы основные команды докера, опробовано создание контейнера и изменение в нём файла, сравнён вывод информации об образе и контейнере и добавлен в файл docker-1.log с описанием
- С помощью docker-machine создан инстанс в GCE с докером внутри для проверки работы основных команд
- В инстансе с докером создан образ reddit и запущен контейнер с ним
- После регистрации на Docker Hub образ reddit залит в него и проверен на развёртывание из другой консоли
- Создан прототип инфраструктуры для развёртывания инстансов с реддитом: шаблон пакера для создания образа инстанса с использованием ansible, плейбук ansible для установки в готовящийся образ пакера сервиса Docker и создание контейнера reddit из Docker Hub с автостартом, шаблон терраформа для развёртывания инстансов из приготовленного пакером образа.

Примечание:
 
- По дефолту контейнеры Docker запускаются в своем изолированном PID_namespace. Однако ключ docker "--pid" позволяет запустить контейнер в системном PID_namespace и внутри контейнера мы увидим все процессы хостовой машины. 
